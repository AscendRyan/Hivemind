<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

  <title>HiveMind AI â€“ Chatbot Widget</title>

  <!-- Keep the iframe page transparent + no inner page scrollbar -->
  <style>
    html, body {
      margin: 0;
      background: transparent;
      overflow: hidden;           /* no second scrollbar inside iframe */
      color-scheme: dark;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
  </style>

  <!-- Hide the INTERNAL launcher button when embedded -->
  <style>
    .hm-embed #chat-button{ display:none !important; }
  </style>

  <style>
    :root{
      --primary-color:#0b0618;
      --secondary-color:#d946ef;
      --secondary-hover:#a855f7;
      --user-bubble:#1c1430;
      --bot-bubble:#141024;
      --text-color:#ffffff;
      --button-text-color:#0b0618;
      --border-radius:16px;
      --transition-speed:.3s;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    /* Container fills the iframe */
    #hivemind-chatbot{
      position:fixed; inset:0; z-index:1;
      display:flex; flex-direction:column-reverse; align-items:flex-end;
      width:100%; height:100%;
      pointer-events:auto;
    }

    /* (only used if you open chatbot.html directly, not in ?embed=1 mode) */
    #chat-button{
      position:static; display:flex; align-items:center; justify-content:center;
      width:60px; height:60px; margin:10px; border-radius:50%;
      background:var(--secondary-color); color:var(--button-text-color);
      cursor:pointer; box-shadow:0 6px 12px rgba(0,0,0,.45);
      transition:transform var(--transition-speed),background var(--transition-speed);
    }
    #chat-button:hover{ transform:scale(1.05); background:var(--secondary-hover) }
    #chat-button svg{ display:block }
    #chat-button.open{
      background:#130f25; color:var(--secondary-color);
      border:2px solid var(--secondary-color);
    }

    /* Window always fills whatever size the PARENT iframe gives it */
    #chat-window{
      width:100%; height:100%; max-width:100%; max-height:100%;
      background:linear-gradient(145deg,#0b0618 0%,#120a27 50%,#1c1136 100%);
      backdrop-filter:blur(18px) saturate(140%); -webkit-backdrop-filter:blur(18px) saturate(140%);
      border-radius:var(--border-radius);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 2px 4px rgba(0,0,0,.6),0 6px 12px rgba(0,0,0,.4),0 12px 24px rgba(0,0,0,.2);
      overflow:hidden; display:flex; flex-direction:column; position:relative;
      opacity:0; visibility:hidden; transform:translateY(60px);
      transition:
        opacity var(--transition-speed),
        transform .4s ease,
        width .4s ease, height .4s ease, border-radius .4s ease,
        visibility 0s linear var(--transition-speed);
      resize:none;
      pointer-events:none;            /* closed: don't intercept clicks */
    }
    #chat-window.open{
      opacity:1; visibility:visible; transform:translateY(0); transition-delay:0s;
      pointer-events:auto;
    }

    /* Header */
    #chat-header{
      display:flex; align-items:center; justify-content:space-between;
      background:#0b0618; padding:12px 16px; border-bottom:1px solid #1e1835;
      flex:0 0 auto;
    }
    #chat-header h3{font-size:16px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px}
    .hivemind-logo{width:24px;height:24px;object-fit:contain;border-radius:4px}

    #chat-header button{
      background:transparent; border:none; color:var(--secondary-color);
      font-size:20px; cursor:pointer; margin-left:8px; transition:color var(--transition-speed), transform .3s ease;
    }
    #chat-header button:hover{ color:var(--secondary-hover); transform:scale(1.08) }
    #chat-header button svg{ width:20px; height:20px; display:block }

    /* Fullscreen inside iframe (parent will expand iframe as well) */
    #chat-window.fullscreen{
      position:fixed; inset:0; width:100vw; height:100vh; border-radius:0; z-index:1001;
    }

    /* Body */
    #chat-body{
      flex:1 1 auto; overflow-y:auto; padding:16px; display:flex; flex-direction:column;
      background:#0b0618; color:var(--text-color); position:relative; overflow-x:hidden;
    }
    #chat-body::before{
      content:''; position:absolute; inset:0; pointer-events:none; z-index:-1;
      background:
        radial-gradient(circle at 30% 70%, rgba(217,70,239,.08), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(168,85,247,.06), transparent 45%);
      animation:drift 28s linear infinite alternate;
    }
    @keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(12%, -10%)}}

    /* Intake */
    #form-container{display:flex;flex-direction:column;gap:12px}
    #form-container label{font-weight:600;margin-bottom:4px;color:#cdbdfd}
    #form-container input{
      padding:8px 10px;border:1px solid #322856;border-radius:8px;font-size:14px;background:#181233;color:var(--text-color);
      box-shadow:-3px -3px 6px rgba(255,255,255,.06) inset, 3px 3px 6px rgba(0,0,0,.22) inset;
    }
    #form-container input::placeholder{color:#8e81a8}
    #form-container input:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 2px rgba(217,70,239,.25)}
    #form-error{color:#ff6b6b;font-size:12px;height:14px}
    #start-btn{
      background:var(--secondary-color);color:#fff;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:700;align-self:flex-start;
      transition:background var(--transition-speed),transform var(--transition-speed); box-shadow:0 4px 8px rgba(0,0,0,.45);
    }
    #start-btn:hover{ background:var(--secondary-hover); transform:scale(1.02) }

    /* Messages */
    #messages-container{display:flex;flex-direction:column;overflow-x:hidden}
    .message-row{display:flex;margin-bottom:10px}
    .message-row.user{justify-content:flex-end}
    .message-row.bot{justify-content:flex-start}
    .message{
      max-width:80%; padding:10px 14px; border-radius:12px; line-height:1.4; word-break:break-word;
      animation:fadeIn .55s cubic-bezier(.22,1,.36,1) both; opacity:0; transform:translateY(10px);
      transition:transform .15s ease-out,box-shadow .15s ease-out; will-change:transform,box-shadow; display:flex; flex-direction:column;
      box-shadow:0 1px 2px rgba(0,0,0,.4),0 2px 4px rgba(0,0,0,.3);
    }
    .message.user{background:var(--user-bubble);border-left:3px solid var(--secondary-color);border-radius:16px 16px 2px 16px;color:#fff}
    .message.bot{background:var(--bot-bubble);border-left:3px solid var(--secondary-color);border-radius:16px 16px 16px 2px;color:#fff}
    @keyframes fadeIn{0%{opacity:0;transform:translateY(12px)}80%{opacity:1;transform:translateY(-4px)}100%{opacity:1;transform:translateY(0)}}
    .avatar{
      width:32px;height:32px;border-radius:50%;background:var(--secondary-color);color:#0b0618;
      display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;margin-right:8px;flex-shrink:0;
      animation:avatarNod 8s ease-in-out infinite;
    }
    @keyframes avatarNod{0%,95%,100%{transform:translateY(0)}50%{transform:translateY(-2px)}}
    .message .meta{display:flex;align-items:center;justify-content:flex-end;gap:4px;font-size:10px;color:#a39ac7;margin-top:4px}
    .message .meta .receipt{font-size:12px;color:var(--secondary-color)}
    .message-row:hover .message{transform:scale(1.02);box-shadow:0 3px 5px rgba(0,0,0,.25),0 6px 12px rgba(0,0,0,.15),0 12px 24px rgba(0,0,0,.08)}

    /* Composer */
    #chat-input-container{display:flex;border-top:1px solid #1e1835;padding:8px;background:#15102b}
    #chat-input-container input{
      flex:1;padding:8px 10px;border:1px solid #322856;border-radius:8px;font-size:14px;background:#1c1638;color:#fff;
      box-shadow:-3px -3px 6px rgba(255,255,255,.06) inset, 3px 3px 6px rgba(0,0,0,.22) inset;
    }
    #chat-input-container input::placeholder{color:#8e81a8}
    #chat-input-container input:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 2px rgba(217,70,239,.25)}
    #send-btn{
      background:var(--secondary-color);color:#fff;border:none;padding:8px 20px;margin-left:8px;border-radius:20px;cursor:pointer;font-weight:700;
      transition:background var(--transition-speed),transform var(--transition-speed);
      display:flex;align-items:center;gap:6px;box-shadow:0 4px 8px rgba(0,0,0,.45)
    }
    #send-btn:hover{ background:var(--secondary-hover); transform:scale(1.02) }
    .send-icon{font-size:16px;line-height:1;margin-top:1px}

    /* FAQ panel */
    #faq-panel{
      position:absolute; top:0; left:0; width:240px; height:100%; background:#120d25;
      border-top-left-radius:var(--border-radius); border-bottom-left-radius:var(--border-radius);
      box-shadow:-4px 0 10px rgba(0,0,0,.5); padding:16px; display:flex; flex-direction:column; gap:10px; overflow-y:auto;
      transform:translateX(-100%); transition:transform var(--transition-speed) ease; z-index:2; overflow-x:hidden;
    }
    #faq-panel.open{ transform:translateX(0) }
    .faq-btn{
      background:#1a1432;border:1px solid #322856;border-radius:8px;padding:10px;font-size:13px;text-align:left;cursor:pointer;color:#fff;
      transition:background var(--transition-speed),border-color var(--transition-speed),color var(--transition-speed);
    }
    .faq-btn:hover{ background:#211a40; border-color:var(--secondary-color); color:var(--secondary-color) }

    /* Inner scrollbars only */
    #faq-panel,#chat-body{scrollbar-width:thin;scrollbar-color:var(--secondary-color) #1a1432}
    #faq-panel::-webkit-scrollbar,#chat-body::-webkit-scrollbar{width:10px;height:10px}
    #faq-panel::-webkit-scrollbar-track,#chat-body::-webkit-scrollbar-track{background:#1a1432;border-radius:5px}
    #faq-panel::-webkit-scrollbar-thumb,#chat-body::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg,var(--secondary-color),#a855f7);border-radius:5px;
    }

    /* Mobile tweak */
    @media (max-width:480px){
      #faq-panel{ width:70vw }
    }
  </style>
</head>
<body>
  <div id="hivemind-chatbot">
    <!-- INTERNAL launcher (hidden in ?embed=1 mode) -->
    <div id="chat-button" title="Chat with HiveMind AI">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3C7.03 3 3 6.58 3 11c0 3.23 2.09 5.84 5 6.87V21l4.1-2.16c.62.1 1.26.16 1.9.16 4.97 0 9-3.58 9-8s-4.03-8-9-8H12Z"/>
      </svg>
    </div>

    <!-- The chat window (fills iframe area) -->
    <div id="chat-window">
      <div id="chat-header">
        <h3>
          <img class="hivemind-logo" alt="HiveMind logo"
               src="https://upload.wikimedia.org/wikipedia/commons/3/38/Hexagon_Icon.svg"/>
          HiveMind AI
        </h3>
        <div style="display:flex;align-items:center;gap:4px">
          <button id="clear-chat" title="Restart conversation">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4.05 11a8 8 0 0 1 13.82-5.36L19 4"/><polyline points="23 4 19 4 19 8"/>
              <path d="M19.95 13a8 8 0 0 1-13.82 5.36L5 20"/><polyline points="1 20 5 20 5 16"/>
            </svg>
          </button>
          <button id="faq-toggle" title="Frequently Asked Questions">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1.93 7.93l-.64.64c-.89.88-1.29 1.48-1.29 2.43v.5h-2v-.5c0-1.22.49-2.06 1.36-2.94l1.2-1.19A2 2 0 1 0 10 6.5a2 2 0 1 0 4 0c0 .84-.35 1.64-.94 2.33zm-.92 8.57a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
            </svg>
          </button>
          <button id="fullscreen-toggle" title="Expand to fullscreen">
            <svg id="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 9 9 9 9 3"/><polyline points="21 15 15 15 15 21"/>
              <line x1="15" y1="9" x2="21" y2="3"/><line x1="9" y1="15" x2="3" y2="21"/>
            </svg>
            <svg id="collapse-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
              <polyline points="7 14 14 14 14 7"/><polyline points="17 10 10 10 10 17"/>
              <line x1="14" y1="14" x2="21" y2="21"/><line x1="10" y1="10" x2="3" y2="3"/>
            </svg>
          </button>
        </div>
      </div>

      <div id="chat-body">
        <!-- Intake -->
        <div id="form-container">
          <p style="color:#cdbdfd;margin-bottom:8px;font-size:14px">
            Share a couple details so we can tailor recommendations.
          </p>
          <div>
            <label for="user-name">Name</label>
            <input type="text" id="user-name" placeholder="Your name" required/>
          </div>
          <div>
            <label for="phone-number">Phone Number</label>
            <input type="tel" id="phone-number" placeholder="Mobile number (UK/INTL)" required/>
          </div>
          <div id="form-error"></div>
          <button id="start-btn">Start Chat</button>
        </div>

        <!-- Messages -->
        <div id="messages-container" class="hidden" aria-live="polite"></div>
      </div>

      <!-- Attachments preview -->
      <div id="file-preview"></div>

      <!-- Composer -->
      <div id="chat-input-container" class="hidden">
        <button id="attach-btn" title="Attach file" style="background:transparent;border:none;color:var(--secondary-color);font-size:18px;margin-right:6px;cursor:pointer;display:flex;align-items:center;justify-content:center" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79l-9.19 9.18a4.5 4.5 0 0 1-6.36 0l-1-1a4.5 4.5 0 0 1 0-6.36L12.73 3.21a3 3 0 0 1 4.24 0l3.07 3.07a3 3 0 0 1 0 4.24l-7.07 7.07a1.5 1.5 0 0 1-2.12 0l-1-1a1.5 1.5 0 0 1 0-2.12l6.36-6.36"/>
          </svg>
        </button>
        <button id="voice-btn" title="Record voice" style="background:transparent;border:none;color:var(--secondary-color);font-size:18px;margin-right:6px;cursor:pointer;display:flex;align-items:center;justify-content:center" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3z"/>
            <path d="M19 11a7 7 0 0 1-14 0"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
        </button>
        <input type="text" id="chat-input" placeholder="Type your messageâ€¦" autocomplete="off" disabled/>
        <button id="send-btn" disabled><span>Send</span> <span class="send-icon">âž¤</span></button>
        <input type="file" id="file-input" multiple style="display:none"
               accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md,.rtf,.csv,.html,.htm,.odt,.ods,.odp,image/*"/>
      </div>

      <!-- FAQ -->
      <div id="faq-panel"></div>

      <!-- Confirm -->
      <div id="confirm-dialog">
        <div class="dialog-box">
          <p>Clear the conversation and start over?</p>
          <div class="dialog-actions">
            <button class="yes">Yes</button>
            <button class="no">No</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function initHiveMindChatbot(){
      const chatButton=document.getElementById('chat-button');
      const chatWindow=document.getElementById('chat-window');
      const clearChatBtn=document.getElementById('clear-chat');
      const formContainer=document.getElementById('form-container');
      const messagesContainer=document.getElementById('messages-container');
      const chatInputContainer=document.getElementById('chat-input-container');
      const chatInput=document.getElementById('chat-input');
      const sendBtn=document.getElementById('send-btn');
      const startBtn=document.getElementById('start-btn');
      const phoneInput=document.getElementById('phone-number');
      const nameInput=document.getElementById('user-name');
      const formError=document.getElementById('form-error');
      const faqPanel=document.getElementById('faq-panel');
      const faqToggle=document.getElementById('faq-toggle');
      const fullscreenToggle=document.getElementById('fullscreen-toggle');
      const expandIcon=document.getElementById('expand-icon');
      const collapseIcon=document.getElementById('collapse-icon');
      const attachBtn=document.getElementById('attach-btn');
      const voiceBtn=document.getElementById('voice-btn');
      const fileInputEl=document.getElementById('file-input');
      const filePreview=document.getElementById('file-preview');
      const confirmDialog=document.getElementById('confirm-dialog');

      let attachments=[]; let isRecording=false; let mediaRecorder; let audioChunks=[];
      let suggestionContainer=null; let userName=''; let isWaiting=false;

      const WEBHOOK_URL='https://4flajfhr.rpcld.cc/webhook/afd20f14-dc8f-4833-b72b-b0dca66f1b92';

      /* Parent comms */
      const tellParent = (type, payload={}) => { try{ window.parent.postMessage({ type, ...payload }, '*'); }catch(e){} };

      /* FAQs */
      const faqs=[
        {question:'What types of automations do you build?',answer:'We design AI-driven automations across Sales, CRM, Ecommerce, Marketing, Customer Service, Operations, and Data/Reporting. Integrations include HubSpot, Salesforce, Shopify, Zendesk, Slack, Google Workspace, Make/n8n, and more.'},
        {question:'How long does an implementation take?',answer:'Most pilots are delivered in 1â€“2 weeks. Larger rollouts typically take 3â€“6 weeks depending on scope.'},
        {question:'Do you support Salesforce/HubSpot?',answer:'Yesâ€”lead routing, enrichment, deduping, sequence triggers, opportunity alerts, ticket automations, and more.'},
        {question:'What is your process?',answer:'Discovery â†’ map workflows â†’ quick wins â†’ pilot â†’ iterate â†’ scale.'},
        {question:'Can you work with our data warehouse?',answer:'Yesâ€”BigQuery, Redshift, Snowflake, Postgres for reporting automations and alerts.'},
        {question:'Do you offer a proof of concept?',answer:'Yesâ€”most clients start with a fixed-scope POC.'}
      ];

      function populateFaq(){
        faqs.forEach(item=>{
          const btn=document.createElement('button');
          btn.classList.add('faq-btn');
          btn.textContent=item.question;
          btn.addEventListener('click',()=>{
            hideSuggestions();
            insertUserMessage(item.question);
            showTyping();
            setTimeout(()=>{hideTyping();insertBotMessage(item.answer);},300);
            faqPanel.classList.remove('open');
          });
          faqPanel.appendChild(btn);
        });
      }

      function scrollToBottom(){ setTimeout(()=>{ messagesContainer.scrollTop=messagesContainer.scrollHeight; },50); }

      function insertUserMessage(text){
        const t=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false});
        const row=document.createElement('div');row.classList.add('message-row','user');
        const bubble=document.createElement('div');bubble.classList.add('message','user');bubble.textContent=text;
        const meta=document.createElement('div');meta.classList.add('meta');
        const ts=document.createElement('span');ts.classList.add('timestamp');ts.textContent=t;
        const r=document.createElement('span');r.classList.add('receipt');r.textContent='âœ“âœ“';
        meta.appendChild(ts);meta.appendChild(r);bubble.appendChild(meta);row.appendChild(bubble);messagesContainer.appendChild(row);scrollToBottom();
      }

      function insertBotMessage(text){
        const t=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false});
        const row=document.createElement('div');row.classList.add('message-row','bot');
        const avatar=document.createElement('div');avatar.classList.add('avatar');avatar.textContent='H';row.appendChild(avatar);
        const bubble=document.createElement('div');bubble.classList.add('message','bot');bubble.innerHTML=text;
        const meta=document.createElement('div');meta.classList.add('meta');
        const ts=document.createElement('span');ts.classList.add('timestamp');ts.textContent=t;
        const r=document.createElement('span');r.classList.add('receipt');r.textContent='âœ“';
        meta.appendChild(ts);meta.appendChild(r);bubble.appendChild(meta);row.appendChild(bubble);messagesContainer.appendChild(row);scrollToBottom();
      }

      let typingRow;
      function showTyping(){
        typingRow=document.createElement('div');typingRow.classList.add('message-row','bot');
        const avatar=document.createElement('div');avatar.classList.add('avatar');avatar.textContent='H';typingRow.appendChild(avatar);
        const bubble=document.createElement('div');bubble.classList.add('message','bot');
        const indicator=document.createElement('div');indicator.classList.add('typing-indicator');indicator.innerHTML='<span></span><span></span><span></span>';
        bubble.appendChild(indicator);typingRow.appendChild(bubble);messagesContainer.appendChild(typingRow);scrollToBottom();
      }
      function hideTyping(){ if(typingRow){ typingRow.remove(); typingRow=null; } }

      function isValidUKMobile(number){
        const cleaned=number.replace(/\s+/g,'');
        return /^((\+44)?7\d{9}|07\d{9}|(\+\d{9,15}))$/.test(cleaned);
      }

      function openChat(){
        if(!chatWindow.classList.contains('open')){
          chatWindow.classList.add('open');
          chatButton.classList.add('open');
          chatButton.innerHTML = collapseIconSVG;
          tellParent('hm:resize', { open:true });
        }
      }
      function closeChat(){
        if(chatWindow.classList.contains('open')){
          chatWindow.classList.remove('open');
          faqPanel.classList.remove('open');
          chatButton.classList.remove('open');
          chatButton.innerHTML = openIconSVG;
          tellParent('hm:resize', { open:false });
        }
      }

      /* Intake start */
      startBtn.addEventListener('click',()=>{
        const name=nameInput.value.trim(); const phone=phoneInput.value.trim();
        if(!name){formError.textContent='Please enter your name.';return;}
        if(!isValidUKMobile(phone)){formError.textContent='Please enter a valid phone number.';return;}
        formError.textContent=''; formContainer.style.display='none';
        messagesContainer.classList.remove('hidden'); chatInputContainer.classList.remove('hidden');
        const sessionId=phone.replace(/\s+/g,''); userName=name;
        chatInput.disabled=false; sendBtn.disabled=false; attachBtn.disabled=false; voiceBtn.disabled=false;

        insertBotMessage(`Hey ${name}! ðŸ‘‹<br/>Welcome to <strong>HiveMind AI</strong>. What would you like to automate?`);
        showSuggestions([
          'Sales Automations','CRM Automations','Ecommerce Automations',
          'Marketing Automations','Customer Service Automations',
          'Operations Automations','Data & Reporting Automations'
        ]);

        faqToggle.style.display='inline-flex';
        clearChatBtn.style.display='inline-flex';

        async function sendMessage(text, files){
          let messageType='text';
          try{
            let response;
            if(files && files.length){
              const hasAudio=files.some(att=>att.type && att.type.startsWith('audio/'));
              messageType=hasAudio?'audio':'file';
              const formData=new FormData();
              formData.append('chatmessage', text || '');
              formData.append('sessionId', sessionId);
              formData.append('messageType', messageType);
              files.forEach((att,i)=>formData.append(`file${i}`,att.file,att.name));
              response=await fetch(WEBHOOK_URL,{method:'POST',body:formData});
            }else{
              const payload={chatmessage:text,sessionId:sessionId,messageType};
              response=await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            }
            const data=await response.json();
            hideTyping();
            if(data && data.response) insertBotMessage(data.response);
            else insertBotMessage('Sorry, an unexpected response was received.');
          }catch(err){
            hideTyping(); insertBotMessage('Sorry, there was an error contacting our service.'); console.error(err);
          }
        }

        async function handleSend(){
          if(isWaiting) return;
          const text=chatInput.value.trim();
          if(!text && attachments.length===0) return;
          insertUserMessage(text || (attachments.length?'ðŸ“Ž Attachments':'')); chatInput.value='';
          hideSuggestions(); showTyping();
          isWaiting=true; chatInput.disabled=true; sendBtn.disabled=true; attachBtn.disabled=true; voiceBtn.disabled=true;
          await sendMessage(text, attachments);
          attachments=[]; filePreview.innerHTML='';
          isWaiting=false; chatInput.disabled=false; sendBtn.disabled=false; attachBtn.disabled=false; voiceBtn.disabled=false;
        }

        sendBtn.addEventListener('click', handleSend);
        chatInput.addEventListener('keypress', e=>{ if(e.key==='Enter'){ e.preventDefault(); handleSend(); } });

        function showSuggestions(options){
          hideSuggestions();
          suggestionContainer=document.createElement('div'); suggestionContainer.id='suggestion-container';
          options.forEach(opt=>{
            const b=document.createElement('button'); b.classList.add('suggestion-btn'); b.textContent=opt;
            b.addEventListener('click', (ev)=>{ b.classList.add('selected'); createRipple(ev); setTimeout(()=>handleChoice(opt),200); });
            suggestionContainer.appendChild(b);
          });
          messagesContainer.appendChild(suggestionContainer); scrollToBottom();
        }
        function hideSuggestions(){ if(suggestionContainer){ suggestionContainer.remove(); suggestionContainer=null; } }
        function handleChoice(choice){
          if(isWaiting) return;
          hideSuggestions(); insertUserMessage(choice); showTyping();
          sendMessage(`Iâ€™m interested in ${choice}.`);
        }

        clearChatBtn.addEventListener('click',()=>{confirmDialog.classList.add('show')});
        const yesBtn=confirmDialog.querySelector('.yes');
        const noBtn=confirmDialog.querySelector('.no');
        yesBtn.addEventListener('click',async ()=>{
          messagesContainer.innerHTML=''; hideSuggestions(); confirmDialog.classList.remove('show');
          try{ await fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({clearChat:'True',sessionId})}); }catch(e){}
          if(userName){
            insertBotMessage(`Hey ${userName}! ðŸ‘‹<br/>Welcome back to <strong>HiveMind AI</strong>. What would you like to automate?`);
            showSuggestions(['Sales Automations','CRM Automations','Ecommerce Automations','Marketing Automations','Customer Service Automations','Operations Automations','Data & Reporting Automations']);
          }
        });
        noBtn.addEventListener('click',()=>{confirmDialog.classList.remove('show')});
      });

      /* toggle (only used if not embedded) */
      const openIconSVG=`<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 3C7.03 3 3 6.58 3 11c0 3.23 2.09 5.84 5 6.87V21l4.1-2.16c.62.1 1.26.16 1.9.16 4.97 0 9-3.58 9-8s-4.03-8-9-8H12Z"/></svg>`;
      const collapseIconSVG=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 10l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
      chatButton.innerHTML=openIconSVG;
      chatButton.addEventListener('click',()=>{ if(chatWindow.classList.contains('open')) closeChat(); else openChat(); });

      /* FAQ toggle */
      faqToggle.addEventListener('click',e=>{ e.stopPropagation(); faqPanel.classList.toggle('open'); });
      faqPanel.addEventListener('click',e=>{ e.stopPropagation(); });
      document.addEventListener('click',e=>{ if(faqPanel.classList.contains('open') && !faqPanel.contains(e.target)) faqPanel.classList.remove('open'); });

      /* fullscreen */
      fullscreenToggle.addEventListener('click',()=>{
        const isFull = chatWindow.classList.toggle('fullscreen');
        if(isFull){ fullscreenToggle.setAttribute('title','Exit fullscreen'); expandIcon.style.display='none'; collapseIcon.style.display='block'; }
        else{ fullscreenToggle.setAttribute('title','Expand to fullscreen'); expandIcon.style.display='block'; collapseIcon.style.display='none'; }
        tellParent("hm:fullscreen", { full:isFull });
      });

      /* Files */
      const MAX_FILES=10; const MAX_FILE_BYTES=25*1024*1024;
      const addFilePreview = (id,label)=>{
        const item=document.createElement('div'); item.classList.add('file-item'); item.dataset.id=id; item.textContent=label;
        const remove=document.createElement('span'); remove.classList.add('remove-file'); remove.textContent='âœ•';
        remove.addEventListener('click',()=>{ attachments=attachments.filter(a=>a.id!==id); item.remove(); });
        item.appendChild(remove); filePreview.appendChild(item);
      };
      attachBtn.addEventListener('click',()=>fileInputEl.click());
      fileInputEl.addEventListener('change',()=>{
        const files=Array.from(fileInputEl.files||[]);
        for(const file of files){
          if(attachments.length>=MAX_FILES){ insertBotMessage(`You can attach up to ${MAX_FILES} files per message.`); break; }
          if(file.size>MAX_FILE_BYTES){ insertBotMessage(`"${file.name}" is too large. Max per file is ${Math.round(MAX_FILE_BYTES/1024/1024)}MB.`); continue; }
          const id=crypto.randomUUID();
          attachments.push({id,name:file.name,label:file.name,file,type:file.type,size:file.size});
          addFilePreview(id,file.name);
        }
        fileInputEl.value='';
      });

      /* Voice */
      voiceBtn.addEventListener('click',async ()=>{
        if(!isRecording){
          try{
            const stream=await navigator.mediaDevices.getUserMedia({audio:true});
            const mimeType =
              MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
              MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
            const ext = mimeType.includes('mp4') ? 'm4a' : 'webm';
            mediaRecorder=new MediaRecorder(stream,{mimeType});
            audioChunks=[];
            mediaRecorder.ondataavailable=e=>{ if(e.data && e.data.size>0) audioChunks.push(e.data); };
            mediaRecorder.onstop=async ()=>{
              const blob=new Blob(audioChunks,{type:mimeType});
              const filename=`voice-message.${ext}`;
              const voiceFile=new File([blob],filename,{type:mimeType});
              const id=crypto.randomUUID();
              attachments.push({id,name:voiceFile.name,label:'Voice message',file:voiceFile,type:voiceFile.type,size:voiceFile.size});
              addFilePreview(id,'Voice message');
              stream.getTracks().forEach(t=>t.stop());
            };
            mediaRecorder.start(); voiceBtn.classList.add('recording'); isRecording=true;
          }catch(err){ console.error('Voice recording error:',err); }
        }else{
          mediaRecorder.stop(); voiceBtn.classList.remove('recording'); isRecording=false;
        }
      });

      /* Ripple */
      function createRipple(event){
        const button=event.currentTarget; const circle=document.createElement('span');
        const diameter=Math.max(button.clientWidth,button.clientHeight); const radius=diameter/2;
        circle.classList.add('ripple'); circle.style.width=circle.style.height=`${diameter}px`;
        const rect=button.getBoundingClientRect();
        circle.style.left=`${event.clientX-rect.left-radius}px`; circle.style.top=`${event.clientY-rect.top-radius}px`;
        const ripples=button.getElementsByClassName('ripple'); while(ripples[0]) ripples[0].remove();
        button.appendChild(circle);
      }
      [chatButton,sendBtn,startBtn].forEach(btn=>btn.addEventListener('click',createRipple));

      /* Parent commands */
      window.addEventListener('message',(e)=>{
        const m=e.data||{};
        if(m.type==='hm:open')  openChat();
        if(m.type==='hm:close') closeChat();
        if(m.type==='hm:fullscreen') chatWindow.classList.toggle('fullscreen', !!m.full);
      });

      /* FAQs list + initial state */
      populateFaq();
      tellParent('hm:resize', { open:false });
    }

    /* Boot: mark embed mode, then init */
    document.addEventListener('DOMContentLoaded', () => {
      const qs = new URLSearchParams(location.search);
      if (qs.has('embed') || qs.get('embedded') === '1') {
        document.documentElement.classList.add('hm-embed');   /* hides internal launcher */
      }
      initHiveMindChatbot();
    });
  </script>
</body>
</html>
